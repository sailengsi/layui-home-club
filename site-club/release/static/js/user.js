layui.define(["laypage","fly","element"],function(i){var n=layui.jquery,e=layui.layer,t=(layui.util,layui.laytpl),o=(layui.form,layui.laypage),a=layui.fly,l=layui.element(),s={},c={mine:n("#LAY_mine"),mineview:n(".mine-view"),minemsg:n("#LAY_minemsg"),infobtn:n("#LAY_btninfo")},r=n("#LAY_uc"),u=n("#LAY_ucm");s.minelog={},s.mine=function(i,n,e){var l=['{{# for(var i = 0; i < d.rows.length; i++){ }}      <li>        {{# if(d.rows[i].collection_time){ }}          <a class="jie-title" href="/jie/{{d.rows[i].id}}.html" target="_blank">{{= d.rows[i].title}}</a>          <i>收藏于{{ d.rows[i].collection_time }}</i>        {{# } else { }}          {{# if(d.rows[i].status == 1){ }}          <span class="fly-jing">精</span>          {{# } }}          {{# if(d.rows[i].accept >= 0){ }}          <span class="jie-status jie-status-ok">已解决</span>          {{# } }}          <a class="jie-title" href="/jie/{{d.rows[i].id}}.html" target="_blank">{{= d.rows[i].title}}</a>          <i>{{new Date(d.rows[i].time).toLocaleString()}}</i>          {{# if(d.rows[i].accept == -1){ }}          <a class="mine-edit" href="/jie/edit/{{d.rows[i].id}}">编辑</a>          {{# } }}          <em>{{d.rows[i].hits}}阅/{{d.rows[i].comment}}答</em>        {{# } }}      </li>      {{# } }}'],r=function(n){var e=t(l[0]).render(n);c.mine.children().eq(i).find("span").html(n.count),u.children().eq(i).find("ul").html(0===n.rows.length?'<div class="fly-msg">没有相关数据</div>':e)},m=function(i){var t=i||1;if(s.minelog[n+"-page-"+t])r(s.minelog[n+"-page-"+t]);else if("collection"===n){var l=10;a.json(e,{},function(n){n.count=n.rows.length;var e=a.sort(n.rows,"collection_timestamp"),c=function(i){var t=[],o=i*l-l,a=o+l-1;a>=e.length&&(a=i>1?e.length-(a-e.length):e.length-1);for(var s=o;a>=s;s++)t.push(e[s]);n.rows=t,r(n)};c(t),s.minelog["collect-page-"+t]=n,i||o({cont:"LAY_page1",pages:Math.ceil(e.length/l),skin:"fly",curr:t,jump:function(i,n){n||c(i.curr)}})})}else a.json("/api/"+n+"/",{page:t},function(n){r(n),s.minelog["mine-jie-page-"+t]=n,i||o({cont:"LAY_page",pages:n.pages,skin:"fly",curr:t,jump:function(i,n){n||m(i.curr)}})})};s.minelog[n]||m()},r[0]&&layui.each(c.mine.children(),function(i,e){var t=n(e);s.mine(i,t.data("type"),t.data("url"))});var m=location.hash.replace(/^#/,"");l.tabChange("user",m),l.on("tab(user)",function(){location.hash=""+n(this).attr("lay-id")}),""===n("#LAY_city").val()&&n.getScript("http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=js",function(){n("#LAY_city").val(remote_ip_info.city)}),n(".upload-img")[0]&&layui.use("upload",function(){var i=n(".avatar-add");layui.upload({elem:".upload-img input",method:"post",url:"/user/upload/",before:function(){i.find(".loading").show()},success:function(t){0==t.status?n.post("/user/set/",{avatar:t.url},function(){location.reload()}):e.msg(t.msg,{icon:5}),i.find(".loading").hide()},error:function(){i.find(".loading").hide()}})}),a.form["set-mine"]=function(){e.msg("修改成功",{icon:1,time:1e3,shade:.1},function(){location.reload()})},n(".acc-unbind").on("click",function(){var i=n(this),t=i.attr("type");e.confirm("整的要解绑"+{qq_id:"QQ",weibo_id:"微博"}[t]+"吗？",{icon:5},function(){a.json("/api/unbind",{type:t},function(i){0===i.status?e.alert("已成功解绑。",{icon:1,end:function(){location.reload()}}):e.msg(i.msg)})})}),s.minemsg=function(){var i=(n("#LAY_delallmsg"),function(i){(i||0===c.minemsg.find(".mine-msg li").length)&&c.minemsg.html('<div class="fly-none">您暂时没有最新消息</div>')});c.minemsg.on("click",".mine-msg li .fly-delete",function(){var t=n(this).parents("li"),o=t.data("id");e.confirm("确定删除该消息吗？",function(){a.json("/message/remove/",{id:o},function(n){0===n.status&&(t.remove(),i())})})}),n("#LAY_delallmsg").on("click",function(){var t=n(this);e.confirm("确定清空吗？",function(n){a.json("/message/remove/",{all:!0},function(o){0===o.status&&(e.close(n),t.addClass("layui-hide"),i(!0))})})})},c.minemsg[0]&&s.minemsg(),i("user",null)});